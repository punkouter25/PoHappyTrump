@page "/"
@using System.Linq
@inject ILogger<Home> Logger
@inject IJSRuntime JSRuntime

<PageTitle>PoHappyTrump - Make America Great Again!</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem" Class="rz-p-4">
    <RadzenText Text="Make America Great Again!" TextStyle="TextStyle.H1" TagName="TagName.H1" Class="rz-text-center" />
    <RadzenText Text="Click the button below to get a positive message!" TextStyle="TextStyle.Subtitle1" TagName="TagName.P" Class="rz-text-center" />

    <RadzenButton Text="Get Positive Message" Click="GetMessage" IsLoading="@isLoading" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Size="ButtonSize.Large" />

    @if (isLoading)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Class="rz-mt-4" />
        <RadzenText Text="Loading..." TextStyle="TextStyle.Body1" TagName="TagName.P" />
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenCard Variant="Variant.Filled" Class="rz-mt-4" Style="background-color: var(--rz-error-light); color: var(--rz-error-dark);">
            <RadzenText Text="@errorMessage" TextStyle="TextStyle.Body1" TagName="TagName.P" />
        </RadzenCard>
    }
    else if (!string.IsNullOrEmpty(message))
    {
        <RadzenCard Variant="Variant.Filled" Class="rz-mt-4 card-fade-in" Style="width: 100%; max-width: 600px;">
            <RadzenStack Orientation="Orientation.Vertical" Gap="0.5rem">
                <RadzenText Text="Positive Message:" TextStyle="TextStyle.H6" TagName="TagName.H6" />
                <RadzenText Text="@message" TextStyle="TextStyle.Body1" TagName="TagName.P" />
                <RadzenButton Icon="content_copy" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Flat" Size="ButtonSize.Small" Click="() => CopyToClipboard(message)" />
            </RadzenStack>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private string? message;
    private string? errorMessage;
    private bool isLoading = false;

    [Inject]
    private HttpClient Http { get; set; } = default!;

    private async Task GetMessage()
    {
        isLoading = true;
        errorMessage = null;
        message = null;
        StateHasChanged(); // Update UI to show loading state

        try
        {
            var apiUrl = "api/TrumpMessage";
            Logger.LogInformation("Fetching message from {ApiUrl}", apiUrl);

            var response = await Http.GetAsync(apiUrl);

            if (response.IsSuccessStatusCode)
            {
                message = await response.Content.ReadAsStringAsync();
                Logger.LogInformation("Received message: {Message}", message);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("API call failed with status: {StatusCode}. Response: {ErrorContent}", response.StatusCode, errorContent);
                errorMessage = "Sorry, we couldn't fetch a message right now. Please try again later.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "An unexpected error occurred while fetching the message.");
            errorMessage = "An unexpected error occurred. Please check the logs for more details.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged(); // Update UI to hide loading state
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }

    [Inject] NavigationManager NavigationManager { get; set; } = default!;
}
